"use strict";exports.id=599,exports.ids=[599],exports.modules={9599:(e,o,t)=>{t.a(e,async(e,a)=>{try{t.d(o,{G:()=>handleFlutterwaveWebhook,f:()=>handleBlockRadarWebhook});var r=t(5788),i=t(7931),l=e([r]);async function handleFlutterwaveWebhook(e,o,t){console.log("Received Flutterwave webhook:",t?.event);let a=(0,r.iO)(e,o);if(!a)throw console.error("Invalid Flutterwave signature"),Error("Invalid Flutterwave signature");if("charge.completed"===t.event){let{status:e,amount:o,customer:a,account_number:r,id:l}=t.data;if(console.log(`Charge completed: ${o} NGN to account ${r}, status: ${e}`),"successful"===e){let{data:e}=await i.OQ.from("transactions").select("id").eq("reference",l).limit(1);if(e&&e.length>0)return console.log(`Transaction ${l} already processed, skipping`),{received:!0,duplicate:!0};let{data:t}=await i.OQ.from("profiles").select("id, email").eq("dva_account_number",r).limit(1),c=t&&t[0];c?(console.log(`Crediting user ${c.id} (${c.email}) with ${o} NGN`),await (0,i.QF)(c.id,"credit",Number(o),l,{kind:"dva_credit",customer:a,account_number:r}),console.log("Transaction recorded successfully")):console.warn(`No profile found for DVA account ${r}`)}}return{received:!0}}async function handleBlockRadarWebhook(e){if(console.log("Received BlockRadar webhook:",e?.event),"transaction.confirmed"===e.event&&"DEPOSIT"===e.data.type){let{id:o,amount:t,asset:a,recipientAddress:r,metadata:l}=e.data,c=a.symbol,s=Number(t);console.log(`Crypto deposit: ${s} ${c} to ${r}`);let{data:d}=await i.OQ.from("transactions").select("id").eq("reference",o).limit(1);if(d&&d.length>0)return console.log(`Transaction ${o} already processed, skipping`),{received:!0,duplicate:!0};let{data:n}=await i.OQ.from("profiles").select("id, email").or(`usdc_address.eq.${r},erc20_address.eq.${r}`).limit(1),u=n&&n[0];if(u){console.log(`Crediting user ${u.id} (${u.email}) with ${s} ${c}`);let e=Number(process.env.EXCHANGE_RATE_USDC_NGN||"1500"),t=s*e;await (0,i.QF)(u.id,"credit",t,o,{kind:"crypto_deposit",symbol:c,cryptoAmount:s,recipientAddress:r,metadata:l}),await (0,i.ag)(u.id,c,s,t),console.log("Crypto deposit recorded successfully")}else console.warn(`No profile found for crypto address ${r}`)}return{received:!0}}r=(l.then?(await l)():l)[0],a()}catch(e){a(e)}})}};