"use strict";exports.id=787,exports.ids=[787],exports.modules={5788:(e,t,a)=>{a.a(e,async(e,n)=>{try{a.d(t,{bb:()=>createDedicatedVirtualAccount,gd:()=>initiateFiatTransfer,iO:()=>verifyFlutterwaveSignature});var r=a(9648);a(1081);var i=e([r]);r=(i.then?(await i)():i)[0];let o=process.env.FLUTTERWAVE_BASE_URL||"https://api.flutterwave.com/v3",s=process.env.FLUTTERWAVE_SECRET_KEY,c=process.env.BVN_FOR_DVA||"2211903400";s||console.warn("FLUTTERWAVE_SECRET_KEY missing");let u=r.default.create({baseURL:o,headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});async function createDedicatedVirtualAccount(e,t){let a={email:t,is_permanent:!0,bvn:c,tx_ref:`onboard-${e}-${Date.now()}`},{data:n}=await u.post("/virtual-account-numbers",a);if(!n||!n.data)throw Error("Failed to create virtual account");return{account_number:n.data.account_number,account_name:n.data.account_name,bank_name:n.data.bank_name,flw_ref:n.data.flw_ref}}async function initiateFiatTransfer(e){let t={account_bank:e.bank_code,account_number:e.account_number,amount:e.amount,narration:e.narration||"NIHA transfer",currency:"NGN",reference:`fiat-${Date.now()}`,debit_subaccount:null},{data:a}=await u.post("/transfers",t);if("success"!==a.status)throw Error("Fiat transfer failed");return a.data}function verifyFlutterwaveSignature(e,t){let a=process.env.FLUTTERWAVE_HASH,n=e["verif-hash"]||e["Verif-Hash"];return a?a===n:(console.warn("FLUTTERWAVE_HASH not set; skipping signature verification"),!0)}n()}catch(e){n(e)}})},7931:(e,t,a)=>{a.d(t,{CW:()=>getCryptoBalance,OQ:()=>o,Q7:()=>getFiatBalance,QF:()=>insertTransaction,ag:()=>upsertCryptoBalance});var n=a(2885);a(1081);let r=process.env.SUPABASE_URL,i=process.env.SUPABASE_SERVICE_ROLE_KEY;r&&i||(console.error("Missing Supabase env vars. Set SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY"),process.exit(1));let o=(0,n.createClient)(r,i,{auth:{autoRefreshToken:!1,persistSession:!1}});async function insertTransaction(e,t,a,n,r){return o.from("transactions").insert({user_id:e,type:t,amount:a,reference:n,meta:r})}async function upsertCryptoBalance(e,t,a,n){let r=await o.from("crypto_balances").select("id, amount, fiat_value").eq("user_id",e).eq("symbol",t).maybeSingle();if(!r.data)return o.from("crypto_balances").insert({user_id:e,symbol:t,amount:a,fiat_value:n});{let e=Number(r.data.amount)+a,t=Number(r.data.fiat_value)+n;return o.from("crypto_balances").update({amount:e,fiat_value:t,updated_at:new Date().toISOString()}).eq("id",r.data.id)}}async function getFiatBalance(e){let{data:t}=await o.from("transactions").select("amount,type").eq("user_id",e);return t?t.reduce((e,t)=>e+("credit"===t.type?Number(t.amount):-Number(t.amount)),0):0}async function getCryptoBalance(e,t){let{data:a}=await o.from("crypto_balances").select("amount").eq("user_id",e).eq("symbol",t).maybeSingle();return a?Number(a.amount):0}}};